<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>Detailed explanation of Raft algorithm &#183; David Zhang</title>
<meta name=title content="Detailed explanation of Raft algorithm &#183; David Zhang"><meta name=description content="Detailed discussion of the simplest implementation details of the Raft algorithm, code examples, and correctness proofs."><meta name=keywords content="Distributed System,CAP Theorem,Distributed consensus algorithm,System Design,Raft algorithm,"><link rel=canonical href=https://wacry.github.io/posts/1735548655536-raft-intro/><link type=text/css rel=stylesheet href=/css/main.bundle.min.c9455136a888f810b3153b0c870cc37fdb2ecd76b7e190c28f78fcf948b4dcdc25750c8c7a8ed2763471a0fcbbd25823b366427798e676836ebfa69f5aaec308.css integrity="sha512-yUVRNqiI+BCzFTsMhwzDf9suzXa34ZDCj3j8+Ui03NwldQyMeo7SdjRxoPy70lgjs2ZCd5jmdoNuv6afWq7DCA=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.a2d78d78672e549fbfc972ece871725b5478ba0b65708dda20cb97ab80a865eae6d247e1b05a4aec6ebbf78647ec3233bad8b2609ed98eee53cd58aa17128bc7.js integrity="sha512-oteNeGcuVJ+/yXLs6HFyW1R4ugtlcI3aIMuXq4CoZerm0kfhsFpK7G6794ZH7DIzutiyYJ7Zju5TzViqFxKLxw==" data-copy data-copied></script><script src=/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://wacry.github.io/posts/1735548655536-raft-intro/"><meta property="og:site_name" content="David Zhang"><meta property="og:title" content="Detailed explanation of Raft algorithm"><meta property="og:description" content="Detailed discussion of the simplest implementation details of the Raft algorithm, code examples, and correctness proofs."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-30T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-30T00:00:00+00:00"><meta property="article:tag" content="Distributed System"><meta property="article:tag" content="CAP Theorem"><meta property="article:tag" content="Distributed Consensus Algorithm"><meta property="article:tag" content="System Design"><meta property="article:tag" content="Raft Algorithm"><meta property="og:image" content="https://wacry.github.io/posts/1735548655536-raft-intro/featured.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wacry.github.io/posts/1735548655536-raft-intro/featured.png"><meta name=twitter:title content="Detailed explanation of Raft algorithm"><meta name=twitter:description content="Detailed discussion of the simplest implementation details of the Raft algorithm, code examples, and correctness proofs."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Detailed explanation of Raft algorithm","headline":"Detailed explanation of Raft algorithm","description":"Detailed discussion of the simplest implementation details of the Raft algorithm, code examples, and correctness proofs.","abstract":"Detailed discussion of the simplest implementation details of the Raft algorithm, code examples, and correctness proofs.","inLanguage":"en","url":"https:\/\/wacry.github.io\/posts\/1735548655536-raft-intro\/","author":{"@type":"Person","name":"David (Ziyuan) Zhang"},"copyrightYear":"2024","dateCreated":"2024-12-30T00:00:00\u002b00:00","datePublished":"2024-12-30T00:00:00\u002b00:00","dateModified":"2024-12-30T00:00:00\u002b00:00","keywords":["Distributed System","CAP Theorem","Distributed consensus algorithm","System Design","Raft algorithm"],"mainEntityOfPage":"true","wordCount":"5180"}]</script><meta name=author content="David (Ziyuan) Zhang"><link href=https://github.com/wacry rel=me><link href=https://icpc.global/ICPCID/6RP5EXAXJZWB rel=me><link href=https://www.linkedin.com/in/dz00/ rel=me><link href=mailto:davidzhang20001112@gmail.com rel=me><link href=https://buymeacoffee.com/davidzhangu rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-0PXDGGP7FP"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0PXDGGP7FP")</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&family=Noto+Sans+KR:wght@100..900&family=Noto+Sans+SC:wght@100..900&family=Noto+Sans+TC:wght@100..900&family=Noto+Sans:wght@100..900&display=swap" rel=stylesheet><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"],["$","$"]]}}</script><meta name=theme-color><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js></script><script src=https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js></script><script>const firebaseConfig={apiKey:"AIzaSyDFtJ-rTtzlvZZtimkDzlcRa9aXD-mBot8",authDomain:"AIzaSyDFtJ-rTtzlvZZtimkDzlcRa9aXD-mBot8",projectId:"wacrygithubio",storageBucket:"wacrygithubio.firebasestorage.app",messagingSenderId:"61945660838",appId:"1:61945660838:web:a02e3d380e60c704f47b67",measurementId:"G-0PXDGGP7FP"};var app=firebase.initializeApp(firebaseConfig),db=firebase.firestore(),auth=firebase.auth()</script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div><a href=/ class=flex><span class=sr-only>David Zhang</span>
<img src=/img/logo.png width=200 height=200 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="David Zhang"></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">David Zhang</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Posts>All Posts</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Tags>Tags</p></a><a href=/series/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Series>Series</p></a><div><div class="cursor-pointer flex items-center nested-menu"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentcolor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span></span><div class="text-sm font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Detailed explanation of Raft algorithm">EN</div></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/posts/1735548655536-raft-intro/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Detailed explanation of Raft algorithm">English</p></a><a href=/zh-cn/posts/1735548655536-raft-intro/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Raft 算法详解">简体中文</p></a></div></div></div></div><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12 h-12"><span></span><div><div class="cursor-pointer flex items-center nested-menu"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentcolor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span></span><div class="text-sm font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Detailed explanation of Raft algorithm">EN</div></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/posts/1735548655536-raft-intro/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Detailed explanation of Raft algorithm">English</p></a><a href=/zh-cn/posts/1735548655536-raft-intro/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Raft 算法详解">简体中文</p></a></div></div></div></div><button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400" style=margin-right:5px><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Posts>All Posts</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Tags>Tags</p></a></li><li class=mt-1><a href=/series/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Series>Series</p></a></li></ul></div></label></div></div><script>(function(){var e=$(".main-menu"),t=window.location.pathname;e.find('a[href="'+t+'"]').each(function(e,t){$(t).children("p").addClass("active")})})()</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="w-full rounded-md h-36 md:h-56 lg:h-72 single_hero_basic nozoom" style=background-image:url(/posts/1735548655536-raft-intro/featured_hu14600660153722536233.png)></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/img/ripples.svg)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-30 dark:opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Detailed explanation of Raft algorithm</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2024-12-30T00:00:00+00:00>30 December 2024</time><span class="px-2 text-primary-500">&#183;</span><span>5180 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">25 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_posts/1735548655536-raft-intro/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_posts/1735548655536-raft-intro/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<button id=button_likes class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400" onclick=process_article()>
<span id=button_likes_heart style=display:none class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
</span></span><span id=button_likes_emtpty_heart class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M244 84l11.1 12 12-11.98C300.6 51.37 347 36.51 392.6 44.1 461.5 55.58 512 115.2 512 185.1V190.9c0 41.5-17.2 81.2-47.6 109.5L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9S235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1.0 232.4.0 190.9V185.1c0-69.9 50.52-129.52 119.4-141 44.7-7.59 92 7.27 124.6 39.9C243.1 84 244 84.01 244 84zm11.1 79.9-45-46.8c-21.7-20.82-52.5-30.7-82.8-25.66C81.55 99.07 48 138.7 48 185.1V190.9c0 28.2 11.71 55.2 32.34 74.4L256 429.3l175.7-164c20.6-19.2 32.3-46.2 32.3-74.4V185.1c0-46.4-33.6-86.03-79.3-93.66C354.4 86.4 323.6 96.28 301.9 117.1l-46.8 46.8z"/></svg>
</span></span><span id=button_likes_text>&nbsp;Like</span>
</button>
</span><span class="px-2 text-primary-500">&#183;</span>
<script type=text/javascript src=/js/zen-mode.min.63c8a202661f4a2063fdc2706685d668e8ea3da613da2224e9da527e5876e4f53dcac39ab60732626fb4151feae5d430d0cf44731e5d3c726522fcc1519c1547.js integrity="sha512-Y8iiAmYfSiBj/cJwZoXWaOjqPaYT2iIk6dpSflh25PU9ysOatgcyYm+0FR/q5dQw0M9Ecx5dPHJlIvzBUZwVRw=="></script><span class=mb-[2px]><span id=zen-mode-button class="text-lg hover:text-primary-500" title="Enable zen mode" data-title-i18n-disable="Enable zen mode" data-title-i18n-enable="Disable zen mode"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentcolor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/distributed-system/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Distributed System
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/cap-theorem/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">CAP Theorem
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/distributed-consensus-algorithm/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Distributed Consensus Algorithm
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/system-design/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">System Design
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/raft-algorithm/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Raft Algorithm</span></span></span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-background-why-is-distributed-consensus-needed>1. Background: Why is Distributed Consensus Needed?</a><ul><li><a href=#11-the-consistency-challenge-in-distributed-systems>1.1 The Consistency Challenge in Distributed Systems</a></li><li><a href=#12-common-consensus-algorithms>1.2 Common Consensus Algorithms</a></li><li><a href=#13-rafts-design-goals>1.3 Raft&rsquo;s Design Goals</a></li><li><a href=#14-raft-visualization>1.4 Raft Visualization</a></li></ul></li><li><a href=#2-rafts-core-ideas>2. Raft&rsquo;s Core Ideas</a><ul><li><a href=#21-process-overview>2.1 Process Overview</a></li><li><a href=#22-data-structures>2.2 Data Structures</a></li></ul></li><li><a href=#3-roles-and-state-transitions>3. Roles and State Transitions</a><ul><li><a href=#31-follower>3.1 Follower</a></li><li><a href=#32-candidate>3.2 Candidate</a></li><li><a href=#33-leader>3.3 Leader</a></li></ul></li><li><a href=#4-leader-election-process>4. Leader Election Process</a></li><li><a href=#5-log-replication>5. Log Replication</a><ul><li><a href=#51-appendentries-rpc>5.1 AppendEntries RPC</a></li><li><a href=#52-core-log-replication-logic>5.2 Core Log Replication Logic</a></li><li><a href=#53-important-guarantees-log-consistency>5.3 Important Guarantees: Log Consistency</a></li></ul></li><li><a href=#6-safety>6. Safety</a><ul><li><a href=#61-why-raft-can-guarantee-consistency>6.1 Why Raft Can Guarantee Consistency</a></li><li><a href=#62-leader-crashes-and-safe-log-inheritance>6.2 Leader Crashes and Safe Log Inheritance</a></li></ul></li><li><a href=#7-implementation-key-points-and-difficulties>7. Implementation Key Points and Difficulties</a><ul><li><a href=#71-election-timeout>7.1 Election Timeout</a></li><li><a href=#72-heartbeat-interval>7.2 Heartbeat Interval</a></li><li><a href=#73-log-conflict-handling>7.3 Log Conflict Handling</a></li><li><a href=#74-persistence>7.4 Persistence</a></li><li><a href=#75-state-machine>7.5 State Machine</a></li><li><a href=#76-cluster-configuration-changes>7.6 Cluster Configuration Changes</a></li></ul></li><li><a href=#8-core-properties-of-raft-correctness-proof>8. Core Properties of Raft Correctness Proof</a><ul><li><a href=#81-distributed-environment-assumptions-and-safetyliveness>8.1 Distributed Environment Assumptions and Safety/Liveness</a></li><li><a href=#82-main-properties-and-overall-approach>8.2 Main Properties and Overall Approach</a></li><li><a href=#83-log-matching-property>8.3 Log Matching Property</a></li><li><a href=#84-leader-completeness-property>8.4 Leader Completeness Property</a></li><li><a href=#85-election-safety>8.5 Election Safety</a></li><li><a href=#86-no-commit-overwritten>8.6 No Commit Overwritten</a></li><li><a href=#87-state-machine-safety>8.7 State Machine Safety</a></li><li><a href=#88-liveness>8.8 Liveness</a></li></ul></li><li><a href=#9-implementing-a-minimal-raft-from-scratch-key-steps>9. Implementing a Minimal Raft from Scratch: Key Steps</a><ul><li><a href=#code-example-minimal-raft-in-c>Code Example: Minimal Raft in C#</a></li></ul></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-background-why-is-distributed-consensus-needed>1. Background: Why is Distributed Consensus Needed?</a><ul><li><a href=#11-the-consistency-challenge-in-distributed-systems>1.1 The Consistency Challenge in Distributed Systems</a></li><li><a href=#12-common-consensus-algorithms>1.2 Common Consensus Algorithms</a></li><li><a href=#13-rafts-design-goals>1.3 Raft&rsquo;s Design Goals</a></li><li><a href=#14-raft-visualization>1.4 Raft Visualization</a></li></ul></li><li><a href=#2-rafts-core-ideas>2. Raft&rsquo;s Core Ideas</a><ul><li><a href=#21-process-overview>2.1 Process Overview</a></li><li><a href=#22-data-structures>2.2 Data Structures</a></li></ul></li><li><a href=#3-roles-and-state-transitions>3. Roles and State Transitions</a><ul><li><a href=#31-follower>3.1 Follower</a></li><li><a href=#32-candidate>3.2 Candidate</a></li><li><a href=#33-leader>3.3 Leader</a></li></ul></li><li><a href=#4-leader-election-process>4. Leader Election Process</a></li><li><a href=#5-log-replication>5. Log Replication</a><ul><li><a href=#51-appendentries-rpc>5.1 AppendEntries RPC</a></li><li><a href=#52-core-log-replication-logic>5.2 Core Log Replication Logic</a></li><li><a href=#53-important-guarantees-log-consistency>5.3 Important Guarantees: Log Consistency</a></li></ul></li><li><a href=#6-safety>6. Safety</a><ul><li><a href=#61-why-raft-can-guarantee-consistency>6.1 Why Raft Can Guarantee Consistency</a></li><li><a href=#62-leader-crashes-and-safe-log-inheritance>6.2 Leader Crashes and Safe Log Inheritance</a></li></ul></li><li><a href=#7-implementation-key-points-and-difficulties>7. Implementation Key Points and Difficulties</a><ul><li><a href=#71-election-timeout>7.1 Election Timeout</a></li><li><a href=#72-heartbeat-interval>7.2 Heartbeat Interval</a></li><li><a href=#73-log-conflict-handling>7.3 Log Conflict Handling</a></li><li><a href=#74-persistence>7.4 Persistence</a></li><li><a href=#75-state-machine>7.5 State Machine</a></li><li><a href=#76-cluster-configuration-changes>7.6 Cluster Configuration Changes</a></li></ul></li><li><a href=#8-core-properties-of-raft-correctness-proof>8. Core Properties of Raft Correctness Proof</a><ul><li><a href=#81-distributed-environment-assumptions-and-safetyliveness>8.1 Distributed Environment Assumptions and Safety/Liveness</a></li><li><a href=#82-main-properties-and-overall-approach>8.2 Main Properties and Overall Approach</a></li><li><a href=#83-log-matching-property>8.3 Log Matching Property</a></li><li><a href=#84-leader-completeness-property>8.4 Leader Completeness Property</a></li><li><a href=#85-election-safety>8.5 Election Safety</a></li><li><a href=#86-no-commit-overwritten>8.6 No Commit Overwritten</a></li><li><a href=#87-state-machine-safety>8.7 State Machine Safety</a></li><li><a href=#88-liveness>8.8 Liveness</a></li></ul></li><li><a href=#9-implementing-a-minimal-raft-from-scratch-key-steps>9. Implementing a Minimal Raft from Scratch: Key Steps</a><ul><li><a href=#code-example-minimal-raft-in-c>Code Example: Minimal Raft in C#</a></li></ul></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})(),function(){var t,e=$("#TableOfContents");if(e.length>0){t=$(window);function n(){var s,o=t.scrollTop(),i=$(".anchor"),n="";if(i.each(function(e,t){t=$(t),t.offset().top-$(window).height()/3<=o&&(n=decodeURIComponent(t.attr("id")))}),s=e.find("a.active"),s.length==1&&s.eq(0).attr("href")=="#"+n)return!0;s.each(function(e,t){$(t).removeClass("active").siblings("ul").hide()}),e.find('a[href="#'+n+'"]').addClass("active"),e.find('a[href="#'+n+'"]').parentsUntil("#TableOfContents").each(function(e,t){$(t).children("a").parents("ul").show()})}t.on("scroll",n),$(document).ready(function(){e.find("a").parent("li").find("ul").hide(),n()})}}()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h2 class="relative group">1. Background: Why is Distributed Consensus Needed?<div id=1-background-why-is-distributed-consensus-needed class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-background-why-is-distributed-consensus-needed aria-label=Anchor>#</a></span></h2><h3 class="relative group">1.1 The Consistency Challenge in Distributed Systems<div id=11-the-consistency-challenge-in-distributed-systems class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#11-the-consistency-challenge-in-distributed-systems aria-label=Anchor>#</a></span></h3><p>In distributed systems, data and computation are spread across multiple servers, each server (node) connected via a network. This approach enhances system throughput and availability, but it also introduces a core challenge: <strong>how to maintain a consistent state or data across multiple nodes.</strong></p><p>Consider a simple example: Suppose we have a distributed key-value storage system. To improve reliability, we need to replicate client write operations across multiple nodes. If a node crashes or a network failure occurs, how do we ensure that the node can obtain the latest state upon recovery? How do we prevent &ldquo;dirty data&rdquo; or inconsistencies? These are the problems that distributed consensus algorithms need to solve.</p><h3 class="relative group">1.2 Common Consensus Algorithms<div id=12-common-consensus-algorithms class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#12-common-consensus-algorithms aria-label=Anchor>#</a></span></h3><p>When it comes to distributed consensus, many people first think of <strong>Paxos</strong>. Paxos has rigorous mathematical proofs, but its implementation and understanding are relatively obscure. In 2014, <strong>Raft</strong> was proposed as a &ldquo;more readable version&rdquo; of Paxos. It breaks down the consensus process into more understandable steps and is easier to implement while ensuring safety. It is widely used in industrial-grade projects such as <strong>etcd</strong>, <strong>Consul</strong>, and <strong>TiKV</strong>.</p><h3 class="relative group">1.3 Raft&rsquo;s Design Goals<div id=13-rafts-design-goals class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#13-rafts-design-goals aria-label=Anchor>#</a></span></h3><ul><li><strong>Easy to understand</strong>: Compared to Paxos, Raft strives for simplicity and clarity in both abstraction and implementation.</li><li><strong>Strong consistency</strong>: Multiple nodes eventually agree on the order and content of log entries.</li><li><strong>High availability</strong>: The system can continue to provide services as long as a <strong>majority of nodes</strong> are alive.</li><li><strong>Scalability</strong>: Supports dynamically adding or removing nodes (configuration changes).</li></ul><h3 class="relative group">1.4 Raft Visualization<div id=14-raft-visualization class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#14-raft-visualization aria-label=Anchor>#</a></span></h3><iframe src=https://raft.github.io/raftscope/index.html title="raft visualization" aria-hidden=true style=border:0;width:800px;height:580px;margin-bottom:20px></iframe><hr><h2 class="relative group">2. Raft&rsquo;s Core Ideas<div id=2-rafts-core-ideas class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-rafts-core-ideas aria-label=Anchor>#</a></span></h2><h3 class="relative group">2.1 Process Overview<div id=21-process-overview class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#21-process-overview aria-label=Anchor>#</a></span></h3><p>Raft breaks down the consensus problem into three sub-problems:</p><ol><li><strong>Leader Election</strong>: How to elect a &ldquo;Leader&rdquo; from multiple nodes.</li><li><strong>Log Replication</strong>: After the Leader receives a write request, how to safely replicate the log to a majority of nodes.</li><li><strong>Safety</strong>: When the Leader crashes or a network partition occurs, how to ensure that the system does not experience log loss or overwriting.</li></ol><p>In Raft, nodes have three roles:</p><ul><li><strong>Leader</strong>: Handles client requests and replicates them to other Followers; monitors failures.</li><li><strong>Follower</strong>: Passively receives log replication RPCs and heartbeats from the Leader.</li><li><strong>Candidate</strong>: A role that competes to become the new Leader during the election phase.</li></ul><p>The system&rsquo;s timeline is divided into a series of <strong>Terms</strong>. There can be at most one legitimate Leader in the same term. If a Leader cannot be successfully elected in the current term or the Leader crashes, the system enters the next term to re-elect.</p><h3 class="relative group">2.2 Data Structures<div id=22-data-structures class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#22-data-structures aria-label=Anchor>#</a></span></h3><p>When implementing Raft, it is usually necessary to maintain:</p><ol><li><strong>Term</strong>: A monotonically increasing number that identifies the current term.</li><li><strong>Log</strong>: Stores client requests or commands. Each log entry includes <code>index</code>, <code>term</code>, and <code>command</code>.</li><li><strong>commitIndex</strong>: The highest log index that has been committed and is visible to the outside world.</li><li><strong>lastApplied</strong>: The highest log index that this node has applied to its local state machine, $\text{lastApplied} \leq \text{commitIndex}$.</li><li><strong>nextIndex[]</strong>: Maintained in the Leader, it records the next log index that needs to be sent to each Follower.</li><li><strong>matchIndex[]</strong>: Maintained in the Leader, it records the highest log index that each Follower has replicated.</li></ol><hr><h2 class="relative group">3. Roles and State Transitions<div id=3-roles-and-state-transitions class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-roles-and-state-transitions aria-label=Anchor>#</a></span></h2><h3 class="relative group">3.1 Follower<div id=31-follower class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#31-follower aria-label=Anchor>#</a></span></h3><ul><li><strong>Initial State</strong>: Nodes are in the Follower state when the system starts; or when a candidate election fails and returns to Follower.</li><li>Behavior:<ul><li>Receives and responds to the Leader&rsquo;s log replication RPCs, heartbeats, and vote requests from candidates.</li><li>If it does not receive any messages from the Leader or candidates within the election timeout period, it transitions to the Candidate state.</li></ul></li></ul><h3 class="relative group">3.2 Candidate<div id=32-candidate class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#32-candidate aria-label=Anchor>#</a></span></h3><ul><li><strong>Trigger Condition</strong>: After a Follower times out, it becomes a Candidate and initiates an election.</li><li>Main Behaviors:<ol><li>Increments <code>currentTerm</code> by 1, and votes for itself (<code>voteFor = self</code>).</li><li>Sends &ldquo;Request Vote&rdquo; RPCs to other nodes in parallel.</li><li>If it receives a majority of votes, it becomes the Leader; if a Leader with a newer term appears, it returns to Follower; if a Leader is not elected before the timeout, it starts the next round of elections.</li></ol></li></ul><h3 class="relative group">3.3 Leader<div id=33-leader class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#33-leader aria-label=Anchor>#</a></span></h3><ul><li><strong>Trigger Condition</strong>: A Candidate receives a majority of votes.</li><li>Main Behaviors:<ol><li>Periodically sends heartbeats (AppendEntries RPC) to all nodes to prevent them from initiating elections.</li><li>Processes client requests, encapsulates them into log entries, writes them to its own log, and then broadcasts them to other Followers. That is, in a strongly consistent scenario, Followers/Candidates are not responsible for handling read/write operations, but only serve as redundancy for the Leader to enhance availability.</li><li>When a majority of nodes have replicated a log entry, it updates <code>commitIndex</code> and notifies Followers to commit.</li><li>Is responsible for updating the cluster configuration (adding/removing nodes) and committing the corresponding log entries in a safe manner.</li></ol></li></ul><hr><h2 class="relative group">4. Leader Election Process<div id=4-leader-election-process class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-leader-election-process aria-label=Anchor>#</a></span></h2><p>Raft&rsquo;s election process can be summarized as follows:</p><ol><li><p><strong>Follower Timeout</strong>
If a Follower does not receive a heartbeat or log replication message from the Leader within the election timeout period, it switches to the Candidate state.</p></li><li><p><strong>Candidate Initiates Election</strong></p><ul><li><code>currentTerm++</code></li><li><code>voteFor = candidateID</code></li><li>Resets the election timer</li><li>Sends &ldquo;Request Vote&rdquo; RPCs to all nodes, including:
$\langle \text{candidateTerm}, \text{candidateId}, \text{lastLogIndex}, \text{lastLogTerm} \rangle$</li></ul></li><li><p><strong>Node Responds to Vote</strong>
If the following conditions are met, the node votes for the requester:</p><ul><li>Requester&rsquo;s term number >= this node&rsquo;s term number</li><li>This node has not voted in this term</li><li>Requester&rsquo;s log is not older than its own (Term is newer or Index is greater)</li></ul><p>Otherwise, it refuses to vote.</p></li><li><p><strong>Election Completion</strong></p><ul><li>If the Candidate receives a majority of votes => becomes the Leader.</li><li>If it does not receive a majority of votes before the timeout => enters the next round of elections (Term is incremented by 1 again).</li><li>If it receives a message from a Leader with a higher term during this period => returns to Follower.</li></ul></li><li><p><strong>Leader Initialization</strong>
After becoming the Leader:</p><ul><li>Initializes <code>nextIndex[] = (Leader's latest log index + 1)</code></li><li>Initializes <code>matchIndex[] = 0</code></li><li>Immediately broadcasts a heartbeat to announce its leadership.</li></ul></li></ol><hr><h2 class="relative group">5. Log Replication<div id=5-log-replication class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5-log-replication aria-label=Anchor>#</a></span></h2><h3 class="relative group">5.1 AppendEntries RPC<div id=51-appendentries-rpc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#51-appendentries-rpc aria-label=Anchor>#</a></span></h3><p>This is the core RPC for Raft log replication and heartbeats. The fields of the request and response are as follows:</p><ul><li><strong>Request</strong>:
$ \langle \text{term}, \text{leaderId}, \text{prevLogIndex}, \text{prevLogTerm}, \text{entries[]}, \text{leaderCommit} \rangle$<ul><li>When <code>entries[]</code> is empty, it acts as a heartbeat.</li><li><code>prevLogIndex</code> and <code>prevLogTerm</code> are used to match the Follower&rsquo;s log. If there is a mismatch, replication fails.</li></ul></li><li><strong>Response</strong>:
$\langle \text{term}, \text{success} \rangle$<ul><li><code>term</code>: The Follower&rsquo;s current term (if it is greater than the requester&rsquo;s, the requester updates its term and returns to Follower).</li><li><code>success</code>: Whether the log was successfully matched and appended.</li></ul></li></ul><h3 class="relative group">5.2 Core Log Replication Logic<div id=52-core-log-replication-logic class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#52-core-log-replication-logic aria-label=Anchor>#</a></span></h3><ol><li><strong>Leader Writes to Local Log First</strong>: Upon receiving a client write request, the Leader first forms a new log entry <code>[index, term, command]</code> and writes it to its own log.</li><li><strong>Leader Sends AppendEntries</strong>: The Leader sends this new log entry to all Followers in parallel.</li><li><strong>Follower Checks and Matches</strong>: If <code>prevLogIndex/prevLogTerm</code> do not match, it returns <code>success = false</code>, and the Leader will roll back and retry.</li><li><strong>Commit</strong>: When the Leader finds that a majority of nodes have replicated a log entry at index N, it updates <code>commitIndex</code> to N and informs the Followers in subsequent heartbeats that they &ldquo;can commit up to N&rdquo;, thereby applying the log to the state machine.</li></ol><h3 class="relative group">5.3 Important Guarantees: Log Consistency<div id=53-important-guarantees-log-consistency class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#53-important-guarantees-log-consistency aria-label=Anchor>#</a></span></h3><ul><li><strong>Log Matching Property</strong>: Same index, same term => all preceding logs are consistent; ensures that there will be no different commands at the same position.</li><li><strong>Leader Completeness Property</strong>: A log entry committed in term $t$ must exist in the log of any Leader elected in any subsequent term; ensures that committed log entries are not discarded or overwritten.</li></ul><hr><h2 class="relative group">6. Safety<div id=6-safety class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#6-safety aria-label=Anchor>#</a></span></h2><h3 class="relative group">6.1 Why Raft Can Guarantee Consistency<div id=61-why-raft-can-guarantee-consistency class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#61-why-raft-can-guarantee-consistency aria-label=Anchor>#</a></span></h3><ol><li><strong>Majority Mechanism</strong>: Decisions (such as committing logs) require agreement from a majority of nodes, tolerating a small number of failures.</li><li><strong>Term Mechanism</strong>: Only trust messages from a higher term, avoiding cross-term log conflicts.</li><li><strong>Log Matching</strong>: Followers must match the previous log entry before appending a new log entry, preventing forks.</li></ol><h3 class="relative group">6.2 Leader Crashes and Safe Log Inheritance<div id=62-leader-crashes-and-safe-log-inheritance class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#62-leader-crashes-and-safe-log-inheritance aria-label=Anchor>#</a></span></h3><ul><li>After a Leader crashes, Followers time out and enter the Candidate state, initiating a new term election.</li><li>If a new Leader is elected, its log must be the &ldquo;newest&rdquo; in the cluster (because the voting rules require a majority of nodes to agree); therefore, committed logs will not be discarded.</li><li>Log entries that have not been replicated to a majority of nodes may be overwritten by the new Leader, but this is the correct &ldquo;safe behavior&rdquo; because these logs have not yet reached consensus in the cluster.</li></ul><hr><h2 class="relative group">7. Implementation Key Points and Difficulties<div id=7-implementation-key-points-and-difficulties class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#7-implementation-key-points-and-difficulties aria-label=Anchor>#</a></span></h2><h3 class="relative group">7.1 Election Timeout<div id=71-election-timeout class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#71-election-timeout aria-label=Anchor>#</a></span></h3><ul><li>The election timeout for each node is randomized within the range of [150ms, 300ms] (or a larger range).</li><li>This reduces conflicts caused by &ldquo;simultaneous elections&rdquo;.</li></ul><h3 class="relative group">7.2 Heartbeat Interval<div id=72-heartbeat-interval class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#72-heartbeat-interval aria-label=Anchor>#</a></span></h3><ul><li>The Leader needs to periodically (e.g., every 50~100ms) send heartbeats to Followers to reset their election timeouts.</li><li>Heartbeats are also empty AppendEntries RPCs, just without any log entries.</li></ul><h3 class="relative group">7.3 Log Conflict Handling<div id=73-log-conflict-handling class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#73-log-conflict-handling aria-label=Anchor>#</a></span></h3><ul><li>When a Follower&rsquo;s log does not match the Leader&rsquo;s, it needs to roll back to the matching position.</li><li>Raft provides several optimization schemes (such as maintaining richer index information in the log) to reduce repeated retries of RPCs.</li></ul><h3 class="relative group">7.4 Persistence<div id=74-persistence class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#74-persistence aria-label=Anchor>#</a></span></h3><ul><li>Raft nodes need to <strong>persist</strong>: <code>currentTerm</code>, <code>voteFor</code>, and the written logs.</li><li>Whenever the term or log is updated, it should first be written to the disk log before returning success, so that the node can recover its state after a crash and restart.</li><li>Raft usually uses sequential log writing + on-demand truncation + snapshots to improve disk write performance.</li></ul><h3 class="relative group">7.5 State Machine<div id=75-state-machine class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#75-state-machine aria-label=Anchor>#</a></span></h3><ul><li>Committed logs are applied to the <strong>state machine</strong>, and the specific logic is defined by the user (e.g., key-value storage, database operations, etc.).</li><li>Raft ensures that the log order is consistent, but the specific execution process takes place in the state machine.</li></ul><h3 class="relative group">7.6 Cluster Configuration Changes<div id=76-cluster-configuration-changes class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#76-cluster-configuration-changes aria-label=Anchor>#</a></span></h3><ul><li>In actual engineering, it is often necessary to add or remove nodes.</li><li>Raft uses a &ldquo;two-phase&rdquo; configuration change mechanism: old configuration -> joint configuration (including old and new nodes) -> new configuration, to prevent majority confusion during configuration transitions.</li></ul><hr><h2 class="relative group">8. Core Properties of Raft Correctness Proof<div id=8-core-properties-of-raft-correctness-proof class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#8-core-properties-of-raft-correctness-proof aria-label=Anchor>#</a></span></h2><h3 class="relative group">8.1 Distributed Environment Assumptions and Safety/Liveness<div id=81-distributed-environment-assumptions-and-safetyliveness class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#81-distributed-environment-assumptions-and-safetyliveness aria-label=Anchor>#</a></span></h3><ol><li>Raft assumes a <strong>partially synchronous network</strong>: that is, the network is synchronous most of the time (with a stable maximum delay), but long delays or partitions may occasionally occur. As long as the network eventually returns to a communicable state, Raft can achieve consensus.</li><li><strong>Safety</strong>: No matter how unstable the network is, there will be no conflicts such as committed logs being rolled back or two nodes applying different commands at the same index.</li><li><strong>Liveness</strong>: As long as the network is in a synchronous state for a sufficient amount of time, Raft will eventually elect a Leader and continuously commit new logs. If the network is always partitioned or messages are lost, even the best distributed algorithm may be blocked. This is the famous FLP (Fischer–Lynch–Paterson) impossibility theorem.</li></ol><h3 class="relative group">8.2 Main Properties and Overall Approach<div id=82-main-properties-and-overall-approach class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#82-main-properties-and-overall-approach aria-label=Anchor>#</a></span></h3><p>Raft relies on the following two core properties to ensure that the system log remains consistent between nodes and does not roll back:</p><ol><li><strong>Log Matching Property</strong>
&ldquo;If the term numbers at log index $i$ of two nodes are the same, then the entire log segment from the beginning to $i$ is consistent.&rdquo;</li><li><strong>Leader Completeness Property</strong>
&ldquo;If a log entry has been committed in term $t$, then any Leader&rsquo;s log in subsequent terms must also contain that log entry.&rdquo;</li></ol><p>Based on these two points, we can derive <strong>State Machine Safety</strong>:</p><blockquote><p>Once a node applies command $cmd$ at index $i$, no other node will apply a different command at the same index $i$ that is not $cmd$.</p></blockquote><h3 class="relative group">8.3 Log Matching Property<div id=83-log-matching-property class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#83-log-matching-property aria-label=Anchor>#</a></span></h3><blockquote><p><strong>Property Statement</strong>: If the term numbers at index $i$ of any two nodes are the same, then the log entries from 1 to $i$ of the two nodes are completely the same (both term and command are consistent).</p></blockquote><ul><li><strong>Proof Approach</strong>: Raft&rsquo;s replication rules require a Follower to match <code>prevLogIndex</code> & <code>prevLogTerm</code> before appending a new log entry; otherwise, it returns failure and causes the Leader to roll back. Therefore, only when their preceding logs are completely consistent can they write the same <code>(index, term)</code>. From this, we can inductively conclude that the same position and the same term must have the same preceding logs.</li></ul><h3 class="relative group">8.4 Leader Completeness Property<div id=84-leader-completeness-property class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#84-leader-completeness-property aria-label=Anchor>#</a></span></h3><blockquote><p><strong>Property Statement</strong>: If a log entry is committed (written to a majority of nodes) in term $t$, then any legitimate Leader in subsequent terms must contain this log entry.</p></blockquote><ul><li><strong>Proof Approach</strong>: A log entry being committed means that a majority has written it; a new Leader being elected requires a majority vote; when voting, each node will refuse to vote for a candidate whose log is &ldquo;behind&rdquo; it. Therefore, a candidate who can be elected must already contain all committed logs; from this, we can infer that the log committed in term $t$ will not be &ldquo;forgotten&rdquo; or overwritten.</li></ul><h3 class="relative group">8.5 Election Safety<div id=85-election-safety class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#85-election-safety aria-label=Anchor>#</a></span></h3><blockquote><p><strong>Proposition</strong>: It is impossible for two different nodes to receive a majority of votes and become Leader in the same term $t$.</p></blockquote><ul><li><strong>Core Reason</strong>: In term $t$, each node can only cast 1 vote. If one candidate has already received a majority of votes, it is impossible for another candidate to also receive a majority of votes (because the nodes in the majority have already voted for the former and cannot vote again).</li></ul><h3 class="relative group">8.6 No Commit Overwritten<div id=86-no-commit-overwritten class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#86-no-commit-overwritten aria-label=Anchor>#</a></span></h3><blockquote><p><strong>Proposition</strong>: If a log entry has been committed, it will not be overwritten with a different command or be revoked.</p></blockquote><ul><li><strong>Proof Approach</strong>: As long as a log has been written to a majority, in order to overwrite it, it is necessary to obtain votes from these majority nodes and successfully write the log. However, if the majority nodes find that a candidate is &ldquo;missing&rdquo; this log, they will refuse to vote or refuse the matching of AppendEntries. Therefore, it is impossible to form a new majority to overwrite this log.</li></ul><h3 class="relative group">8.7 State Machine Safety<div id=87-state-machine-safety class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#87-state-machine-safety aria-label=Anchor>#</a></span></h3><blockquote><p><strong>Proposition</strong>: If node A applies command $cmd$ at index $i$, then no node B will apply a different command $cmd' \neq cmd$ at the same index $i$.</p></blockquote><ul><li><strong>Proof Approach</strong>: Applying to the state machine means that the log has been committed; committing means that it has been replicated to a majority, and the subsequent new Leader will also carry this log; it is impossible for a parallel, conflicting log to be written to the same index and be accepted by a majority of nodes.</li></ul><h3 class="relative group">8.8 Liveness<div id=88-liveness class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#88-liveness aria-label=Anchor>#</a></span></h3><ul><li>In a normal partially synchronous network, once a Leader is stable, client requests will be continuously committed.</li><li>If the Leader crashes or the network is temporarily partitioned, an election will be initiated after recovery, and a new Leader will eventually be elected.</li><li>In a completely asynchronous or permanently partitioned situation, all distributed consensus protocols cannot guarantee inevitable liveness (FLP theorem), but as long as the network is &ldquo;occasionally stable&rdquo;, Raft can continue to move forward.</li></ul><p>In summary, Raft&rsquo;s design balances the three major goals of <strong>easy to understand</strong>, <strong>easy to implement</strong>, and <strong>strong consistency</strong>. Through terms, elections, log replication, and majority mechanisms, it ensures the linearizable semantics of data in distributed systems. Its core safety can be summarized as:</p><ul><li>There will not be two legitimate Leaders at the same time.</li><li>Committed logs are never rolled back.</li><li>Committed logs are still retained by the new Leader.</li><li>Ensures that the same (index, term) position will not have different commands on different nodes.</li><li>Ensures that logs committed in a certain term will not disappear on subsequent Leaders.</li></ul><hr><h2 class="relative group">9. Implementing a Minimal Raft from Scratch: Key Steps<div id=9-implementing-a-minimal-raft-from-scratch-key-steps class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#9-implementing-a-minimal-raft-from-scratch-key-steps aria-label=Anchor>#</a></span></h2><ol><li><strong>Define Data Structures</strong><ul><li><code>currentTerm</code>, <code>voteFor</code>, <code>log[]</code>, <code>commitIndex</code>, <code>lastApplied</code>, etc.</li><li>Node roles (Follower/Candidate/Leader)</li><li>Timers, RPC channels, etc.</li></ul></li><li><strong>Persistence Layer</strong><ul><li>Write key data such as term, votes, and logs to disk or store in a storage engine such as RocksDB.</li><li>Load from storage first when restarting.</li></ul></li><li><strong>RPC Communication Layer</strong><ul><li>Implement two types of RPCs: <code>RequestVote</code> and <code>AppendEntries</code>.</li><li>Handle network exceptions and timeout retries.</li></ul></li><li><strong>Event Loop & Timers</strong><ul><li>Periodically check if a heartbeat has been received from the Leader.</li><li>Initiate an election if a timeout occurs.</li><li>If it is a Leader, send heartbeats periodically.</li><li>Process network RPCs and update local state.</li></ul></li><li><strong>Leader Election</strong><ul><li>Follower timeout -> Candidate initiates voting -> If a majority is obtained -> Leader</li><li>If it fails or encounters a Leader with a higher term -> returns to Follower</li></ul></li><li><strong>Log Replication</strong><ul><li>Leader receives a new command -> writes to local log -> AppendEntries to Followers</li><li>Majority of nodes replicate -> Leader commits and notifies Followers to commit</li></ul></li><li><strong>Fault Recovery</strong><ul><li>After a node restarts, it first restores its state from storage.</li><li>After a Leader or network failure, a new Leader will continue to be elected through the election timeout mechanism.</li></ul></li><li><strong>Testing and Verification</strong><ul><li>Simulate network delays, partitions, node failures, etc., to check whether Raft can correctly maintain consistency and external availability.</li></ul></li></ol><h3 class="relative group">Code Example: Minimal Raft in C#<div id=code-example-minimal-raft-in-c class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#code-example-minimal-raft-in-c aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span><span style=color:#ff79c6>using</span> System;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span><span style=color:#ff79c6>using</span> System.Collections.Generic;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span><span style=color:#ff79c6>using</span> System.Linq;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span><span style=color:#ff79c6>using</span> System.Threading;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span><span style=color:#ff79c6>using</span> System.Threading.Tasks;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span><span style=color:#6272a4>// This code example focuses on the core election logic of the Raft algorithm, omitting details such as network communication and persistence.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span><span style=color:#ff79c6>namespace</span> RaftDemo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span>    <span style=color:#ff79c6>#region</span> Data Structures
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>enum</span> NodeRole
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span>        Follower,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span>        Candidate,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span>        Leader
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>LogEntry</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> Index { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> Term { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>string</span> Command { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>RequestVoteRequest</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> Term { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>string</span> CandidateId { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> LastLogIndex { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> LastLogTerm { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>RequestVoteResponse</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> Term { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>bool</span> VoteGranted { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>AppendEntriesRequest</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> Term { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>string</span> LeaderId { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> PrevLogIndex { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> PrevLogTerm { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> List&lt;LogEntry&gt; Entries { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; } = <span style=color:#ff79c6>new</span> List&lt;LogEntry&gt;();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> LeaderCommit { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>AppendEntriesResponse</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> Term { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>bool</span> Success { <span style=color:#ff79c6>get</span>; <span style=color:#ff79c6>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span>        <span style=color:#6272a4>// To simplify, no additional rollback information is carried here; if more information is included, nextIndex can be rolled back more quickly to find the matching position, reducing the number of network interactions.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>interface</span> <span style=color:#50fa7b>IRaftRpc</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span>        RequestVoteResponse RequestVote(RequestVoteRequest request);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span>        AppendEntriesResponse AppendEntries(AppendEntriesRequest request);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span>    <span style=color:#ff79c6>#endregion</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span>    <span style=color:#ff79c6>#region</span> RaftNode Core Class
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>RaftNode</span> : IRaftRpc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>readonly</span> <span style=color:#8be9fd>string</span> _nodeId;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>readonly</span> InMemoryDispatcher _dispatcher;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>readonly</span> Random _rand = <span style=color:#ff79c6>new</span> Random();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> NodeRole _role = NodeRole.Follower;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> _currentTerm = <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>string</span> _votedFor = <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> List&lt;LogEntry&gt; _log = <span style=color:#ff79c6>new</span> List&lt;LogEntry&gt;();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> _commitIndex = <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> _lastApplied = <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span>        <span style=color:#6272a4>// Only Leaders need to maintain these</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> Dictionary&lt;<span style=color:#8be9fd>string</span>, <span style=color:#8be9fd>int</span>&gt; _nextIndex = <span style=color:#ff79c6>new</span> Dictionary&lt;<span style=color:#8be9fd>string</span>, <span style=color:#8be9fd>int</span>&gt;();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> Dictionary&lt;<span style=color:#8be9fd>string</span>, <span style=color:#8be9fd>int</span>&gt; _matchIndex = <span style=color:#ff79c6>new</span> Dictionary&lt;<span style=color:#8be9fd>string</span>, <span style=color:#8be9fd>int</span>&gt;();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> CancellationTokenSource _cts;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> Task _timerTask;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span>        <span style=color:#6272a4>// The state machine in the demo uses a simple list to record commands</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> List&lt;<span style=color:#8be9fd>string</span>&gt; _stateMachine = <span style=color:#ff79c6>new</span> List&lt;<span style=color:#8be9fd>string</span>&gt;();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> RaftNode(<span style=color:#8be9fd>string</span> nodeId, InMemoryDispatcher dispatcher)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span>            _nodeId = nodeId;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span>            _dispatcher = dispatcher;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> Start()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span>            _dispatcher.RegisterNode(_nodeId, <span style=color:#ff79c6>this</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span>            ResetTimer();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> Stop()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span>            _cts?.Cancel();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span>        <span style=color:#6272a4>// For testing, input commands from external sources</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> SendClientCommand(<span style=color:#8be9fd>string</span> command)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>            <span style=color:#ff79c6>if</span> (_role != NodeRole.Leader)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>                Console.WriteLine(<span style=color:#f1fa8c>$&#34;[{_nodeId}] I&#39;m not the leader, ignoring client command.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>                <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>            <span style=color:#6272a4>// 1. Append the command to the local log</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>            <span style=color:#8be9fd>var</span> newLogIndex = LastLogIndex() + <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>            _log.Add(<span style=color:#ff79c6>new</span> LogEntry
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>                Index = newLogIndex,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>                Term = _currentTerm,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>                Command = command
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>            });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span>            Console.WriteLine(<span style=color:#f1fa8c>$&#34;[{_nodeId}] Leader received client command &#39;{command}&#39;, logIndex={newLogIndex}.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128</span><span>            <span style=color:#6272a4>// 2. Asynchronously send AppendEntries to other nodes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129</span><span>            BroadcastAppendEntries();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132</span><span>        <span style=color:#ff79c6>#region</span> Core RPC Implementation
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> RequestVoteResponse RequestVote(RequestVoteRequest request)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136</span><span>            <span style=color:#ff79c6>lock</span> (<span style=color:#ff79c6>this</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>                <span style=color:#6272a4>// If the term in the request is higher than the local term, update the local term and become a Follower</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>                <span style=color:#ff79c6>if</span> (request.Term &gt; _currentTerm)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>                    _currentTerm = request.Term;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>                    _role = NodeRole.Follower;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>                    _votedFor = <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>                <span style=color:#8be9fd>var</span> response = <span style=color:#ff79c6>new</span> RequestVoteResponse
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148</span><span>                    Term = _currentTerm,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149</span><span>                    VoteGranted = <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150</span><span>                };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>                <span style=color:#6272a4>// If the term in the request is less than the local term, reject the vote</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>                <span style=color:#ff79c6>if</span> (request.Term &lt; _currentTerm)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>                    <span style=color:#ff79c6>return</span> response;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">158</span><span>                <span style=color:#6272a4>// Check if already voted for another candidate or if the log is up-to-date</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159</span><span>                <span style=color:#8be9fd>var</span> myLastLogIndex = LastLogIndex();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>                <span style=color:#8be9fd>var</span> myLastLogTerm = LastLogTerm();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>                <span style=color:#8be9fd>bool</span> logIsAtLeastUpToDate =
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span>                    (request.LastLogTerm &gt; myLastLogTerm) ||
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164</span><span>                    (request.LastLogTerm == myLastLogTerm &amp;&amp; request.LastLogIndex &gt;= myLastLogIndex);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166</span><span>                <span style=color:#ff79c6>if</span> ((_votedFor == <span style=color:#ff79c6>null</span> || _votedFor == request.CandidateId) &amp;&amp; logIsAtLeastUpToDate)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168</span><span>                    _votedFor = request.CandidateId;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169</span><span>                    response.VoteGranted = <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170</span><span>                    <span style=color:#6272a4>// Reset the election timeout</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171</span><span>                    ResetTimer();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174</span><span>                <span style=color:#ff79c6>return</span> response;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">177</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">178</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> AppendEntriesResponse AppendEntries(AppendEntriesRequest request)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">179</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">180</span><span>            <span style=color:#ff79c6>lock</span> (<span style=color:#ff79c6>this</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">181</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">182</span><span>                <span style=color:#8be9fd>var</span> response = <span style=color:#ff79c6>new</span> AppendEntriesResponse
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">183</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">184</span><span>                    Term = _currentTerm,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">185</span><span>                    Success = <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">186</span><span>                };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">187</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">188</span><span>                <span style=color:#6272a4>// If the term is less than the local term, reject the request</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">189</span><span>                <span style=color:#ff79c6>if</span> (request.Term &lt; _currentTerm)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">190</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">191</span><span>                    <span style=color:#ff79c6>return</span> response;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">192</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">193</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">194</span><span>                <span style=color:#6272a4>// If the term is higher than the local term, update the term and become a Follower</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">195</span><span>                <span style=color:#ff79c6>if</span> (request.Term &gt; _currentTerm)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">196</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">197</span><span>                    _currentTerm = request.Term;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">198</span><span>                    _role = NodeRole.Follower;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">199</span><span>                    _votedFor = <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">200</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">201</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">202</span><span>                <span style=color:#6272a4>// Received a heartbeat/log replication from the Leader, reset the election timeout</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">203</span><span>                ResetTimer();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">204</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">205</span><span>                <span style=color:#6272a4>// Simplified basic checks:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">206</span><span>                <span style=color:#6272a4>// Check if the local log at prevLogIndex has the same term</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">207</span><span>                <span style=color:#ff79c6>if</span> (request.PrevLogIndex &gt; <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">208</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">209</span><span>                    <span style=color:#ff79c6>if</span> (request.PrevLogIndex &gt; _log.Count)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">210</span><span>                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">211</span><span>                        <span style=color:#6272a4>// Does not match (local log is shorter than the Leader&#39;s)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">212</span><span>                        <span style=color:#ff79c6>return</span> response;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">213</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">214</span><span>                    <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">215</span><span>                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">216</span><span>                        <span style=color:#8be9fd>var</span> localTerm = _log[request.PrevLogIndex - <span style=color:#bd93f9>1</span>].Term;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">217</span><span>                        <span style=color:#ff79c6>if</span> (localTerm != request.PrevLogTerm)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">218</span><span>                        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">219</span><span>                            <span style=color:#6272a4>// Does not match (term conflict)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">220</span><span>                            <span style=color:#ff79c6>return</span> response;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">221</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">222</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">223</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">224</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">225</span><span>                <span style=color:#6272a4>// If it matches, continue: first overwrite any conflicting logs</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">226</span><span>                <span style=color:#ff79c6>foreach</span> (<span style=color:#8be9fd>var</span> entry <span style=color:#ff79c6>in</span> request.Entries)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">227</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">228</span><span>                    <span style=color:#ff79c6>if</span> (entry.Index &lt;= _log.Count)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">229</span><span>                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">230</span><span>                        <span style=color:#6272a4>// Existing log at the same index, check for conflict</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">231</span><span>                        <span style=color:#ff79c6>if</span> (_log[entry.Index - <span style=color:#bd93f9>1</span>].Term != entry.Term)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">232</span><span>                        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">233</span><span>                            _log[entry.Index - <span style=color:#bd93f9>1</span>] = entry;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">234</span><span>                            Console.WriteLine(<span style=color:#f1fa8c>$&#34;[{_nodeId}] Overwritten log at index {entry.Index} with term {entry.Term}.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">235</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">236</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">237</span><span>                    <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">238</span><span>                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">239</span><span>                        _log.Add(entry);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">240</span><span>                        Console.WriteLine(<span style=color:#f1fa8c>$&#34;[{_nodeId}] Appended log at index {entry.Index} with term {entry.Term}.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">241</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">242</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">243</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">244</span><span>                <span style=color:#6272a4>// Update commitIndex</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">245</span><span>                <span style=color:#ff79c6>if</span> (request.LeaderCommit &gt; _commitIndex)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">246</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">247</span><span>                    _commitIndex = Math.Min(request.LeaderCommit, _log.Count);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">248</span><span>                    ApplyStateMachine();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">249</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">250</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">251</span><span>                response.Success = <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">252</span><span>                response.Term = _currentTerm;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">253</span><span>                <span style=color:#ff79c6>return</span> response;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">254</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">255</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">256</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">257</span><span>        <span style=color:#ff79c6>#endregion</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">258</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">259</span><span>        <span style=color:#ff79c6>#region</span> Election and Heartbeat Timers
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">260</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">261</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>void</span> ResetTimer()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">262</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">263</span><span>            _cts?.Cancel();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">264</span><span>            _cts = <span style=color:#ff79c6>new</span> CancellationTokenSource();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">265</span><span>            _timerTask = RunTimer(_cts.Token);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">266</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">267</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">268</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>async</span> Task RunTimer(CancellationToken token)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">269</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">270</span><span>            <span style=color:#6272a4>// In a production environment, the election timeout is typically set to around 150~300ms,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">271</span><span>            <span style=color:#6272a4>// here it&#39;s extended to 1.5~3 seconds for demonstration purposes, making it easier to observe log outputs in the Console.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">272</span><span>            <span style=color:#8be9fd>var</span> electionTimeout = _rand.Next(<span style=color:#bd93f9>1500</span>, <span style=color:#bd93f9>3000</span>); <span style=color:#6272a4>// Random between 1.5~3s</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">273</span><span>            <span style=color:#8be9fd>var</span> heartbeatInterval = <span style=color:#bd93f9>500</span>; <span style=color:#6272a4>// Leader heartbeat interval 0.5s</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">274</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">275</span><span>            <span style=color:#8be9fd>var</span> start = DateTime.UtcNow;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">276</span><span>            <span style=color:#ff79c6>while</span> (!token.IsCancellationRequested)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">277</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">278</span><span>                <span style=color:#ff79c6>await</span> Task.Delay(<span style=color:#bd93f9>100</span>, token);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">279</span><span>                <span style=color:#8be9fd>var</span> elapsed = (DateTime.UtcNow - start).TotalMilliseconds;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">280</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">281</span><span>                <span style=color:#ff79c6>if</span> (_role == NodeRole.Leader)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">282</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">283</span><span>                    <span style=color:#6272a4>// Leader periodically sends heartbeats</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">284</span><span>                    <span style=color:#ff79c6>if</span> (elapsed &gt;= heartbeatInterval)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">285</span><span>                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">286</span><span>                        BroadcastAppendEntries();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">287</span><span>                        start = DateTime.UtcNow;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">288</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">289</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">290</span><span>                <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">291</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">292</span><span>                    <span style=color:#6272a4>// Follower or Candidate, need to check if election should be triggered</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">293</span><span>                    <span style=color:#ff79c6>if</span> (elapsed &gt;= electionTimeout)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">294</span><span>                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">295</span><span>                        BecomeCandidate();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">296</span><span>                        start = DateTime.UtcNow;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">297</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">298</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">299</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">300</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">301</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">302</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>void</span> BecomeCandidate()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">303</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">304</span><span>            <span style=color:#ff79c6>lock</span> (<span style=color:#ff79c6>this</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">305</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">306</span><span>                _role = NodeRole.Candidate;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">307</span><span>                _currentTerm++;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">308</span><span>                _votedFor = _nodeId;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">309</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">310</span><span>                Console.WriteLine(<span style=color:#f1fa8c>$&#34;[{_nodeId}] Timeout -&gt; Candidate. term={_currentTerm}&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">311</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">312</span><span>                <span style=color:#6272a4>// Reset the election timeout</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">313</span><span>                ResetTimer();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">314</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">315</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">316</span><span>            <span style=color:#6272a4>// Initiate voting</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">317</span><span>            <span style=color:#8be9fd>var</span> request = <span style=color:#ff79c6>new</span> RequestVoteRequest
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">318</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">319</span><span>                Term = _currentTerm,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">320</span><span>                CandidateId = _nodeId,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">321</span><span>                LastLogIndex = LastLogIndex(),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">322</span><span>                LastLogTerm = LastLogTerm()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">323</span><span>            };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">324</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">325</span><span>            <span style=color:#8be9fd>var</span> votesGranted = <span style=color:#bd93f9>1</span>; <span style=color:#6272a4>// Vote for self</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">326</span><span>            <span style=color:#8be9fd>var</span> totalNodes = _dispatcher.GetAllNodes().Count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">327</span><span>            <span style=color:#8be9fd>var</span> majority = totalNodes / <span style=color:#bd93f9>2</span> + <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">328</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">329</span><span>            <span style=color:#ff79c6>foreach</span> (<span style=color:#8be9fd>var</span> otherId <span style=color:#ff79c6>in</span> _dispatcher.GetAllNodes().Where(id =&gt; id != _nodeId))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">330</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">331</span><span>                Task.Run(() =&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">332</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">333</span><span>                    <span style=color:#8be9fd>var</span> resp = _dispatcher.SendRequestVote(otherId, request);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">334</span><span>                    <span style=color:#ff79c6>if</span> (resp != <span style=color:#ff79c6>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">335</span><span>                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">336</span><span>                        <span style=color:#ff79c6>lock</span> (<span style=color:#ff79c6>this</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">337</span><span>                        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">338</span><span>                            <span style=color:#6272a4>// If the other node&#39;s term is higher, become a Follower</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">339</span><span>                            <span style=color:#ff79c6>if</span> (resp.Term &gt; _currentTerm)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">340</span><span>                            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">341</span><span>                                _currentTerm = resp.Term;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">342</span><span>                                _role = NodeRole.Follower;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">343</span><span>                                _votedFor = <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">344</span><span>                                <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">345</span><span>                            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">346</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">347</span><span>                            <span style=color:#ff79c6>if</span> (resp.VoteGranted &amp;&amp; _role == NodeRole.Candidate &amp;&amp; resp.Term == _currentTerm)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">348</span><span>                            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">349</span><span>                                votesGranted++;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">350</span><span>                                <span style=color:#ff79c6>if</span> (votesGranted &gt;= majority)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">351</span><span>                                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">352</span><span>                                    BecomeLeader();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">353</span><span>                                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">354</span><span>                            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">355</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">356</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">357</span><span>                });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">358</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">359</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">360</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">361</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>void</span> BecomeLeader()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">362</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">363</span><span>            <span style=color:#ff79c6>if</span> (_role != NodeRole.Candidate) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">364</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">365</span><span>            _role = NodeRole.Leader;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">366</span><span>            Console.WriteLine(<span style=color:#f1fa8c>$&#34;[{_nodeId}] Became Leader at term {_currentTerm}!&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">367</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">368</span><span>            <span style=color:#6272a4>// Initialize nextIndex and matchIndex</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">369</span><span>            <span style=color:#ff79c6>foreach</span> (<span style=color:#8be9fd>var</span> node <span style=color:#ff79c6>in</span> _dispatcher.GetAllNodes())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">370</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">371</span><span>                <span style=color:#ff79c6>if</span> (node == _nodeId) <span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">372</span><span>                _nextIndex[node] = LastLogIndex() + <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">373</span><span>                _matchIndex[node] = <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">374</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">375</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">376</span><span>            <span style=color:#6272a4>// Immediately send a heartbeat</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">377</span><span>            BroadcastAppendEntries();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">378</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">379</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">380</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>void</span> BroadcastAppendEntries()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">381</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">382</span><span>            <span style=color:#ff79c6>lock</span> (<span style=color:#ff79c6>this</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">383</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">384</span><span>                <span style=color:#ff79c6>if</span> (_role != NodeRole.Leader) <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">385</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">386</span><span>                <span style=color:#ff79c6>foreach</span> (<span style=color:#8be9fd>var</span> otherId <span style=color:#ff79c6>in</span> _dispatcher.GetAllNodes().Where(id =&gt; id != _nodeId))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">387</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">388</span><span>                    <span style=color:#8be9fd>var</span> prevLogIndex = _nextIndex[otherId] - <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">389</span><span>                    <span style=color:#8be9fd>var</span> prevLogTerm = (prevLogIndex &gt; <span style=color:#bd93f9>0</span> &amp;&amp; prevLogIndex &lt;= _log.Count)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">390</span><span>                        ? _log[prevLogIndex - <span style=color:#bd93f9>1</span>].Term : <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">391</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">392</span><span>                    <span style=color:#6272a4>// Simplified: send only a limited set of logs each time</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">393</span><span>                    <span style=color:#6272a4>// Can send more as needed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">394</span><span>                    <span style=color:#8be9fd>var</span> entriesToSend = <span style=color:#ff79c6>new</span> List&lt;LogEntry&gt;();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">395</span><span>                    <span style=color:#ff79c6>if</span> (prevLogIndex &lt; _log.Count)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">396</span><span>                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">397</span><span>                        entriesToSend = _log.Skip(prevLogIndex).ToList();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">398</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">399</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">400</span><span>                    <span style=color:#8be9fd>var</span> request = <span style=color:#ff79c6>new</span> AppendEntriesRequest
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">401</span><span>                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">402</span><span>                        Term = _currentTerm,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">403</span><span>                        LeaderId = _nodeId,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">404</span><span>                        PrevLogIndex = prevLogIndex,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">405</span><span>                        PrevLogTerm = prevLogTerm,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">406</span><span>                        Entries = entriesToSend,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">407</span><span>                        LeaderCommit = _commitIndex
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">408</span><span>                    };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">409</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">410</span><span>                    Task.Run(() =&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">411</span><span>                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">412</span><span>                        <span style=color:#8be9fd>var</span> resp = _dispatcher.SendAppendEntries(otherId, request);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">413</span><span>                        <span style=color:#ff79c6>if</span> (resp != <span style=color:#ff79c6>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">414</span><span>                        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">415</span><span>                            <span style=color:#ff79c6>lock</span> (<span style=color:#ff79c6>this</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">416</span><span>                            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">417</span><span>                                <span style=color:#ff79c6>if</span> (resp.Term &gt; _currentTerm)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">418</span><span>                                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">419</span><span>                                    _currentTerm = resp.Term;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">420</span><span>                                    _role = NodeRole.Follower;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">421</span><span>                                    _votedFor = <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">422</span><span>                                    <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">423</span><span>                                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">424</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">425</span><span>                                <span style=color:#ff79c6>if</span> (resp.Success)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">426</span><span>                                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">427</span><span>                                    <span style=color:#6272a4>// Indicates the other node has matched prevLogIndex</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">428</span><span>                                    <span style=color:#6272a4>// Update nextIndex &amp; matchIndex</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">429</span><span>                                    <span style=color:#8be9fd>var</span> lastEntry = entriesToSend.LastOrDefault();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">430</span><span>                                    <span style=color:#ff79c6>if</span> (lastEntry != <span style=color:#ff79c6>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">431</span><span>                                    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">432</span><span>                                        _matchIndex[otherId] = lastEntry.Index;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">433</span><span>                                        _nextIndex[otherId] = lastEntry.Index + <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">434</span><span>                                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">435</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">436</span><span>                                    <span style=color:#6272a4>// Update commitIndex</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">437</span><span>                                    UpdateCommitIndex();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">438</span><span>                                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">439</span><span>                                <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">440</span><span>                                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">441</span><span>                                    <span style=color:#6272a4>// Decrement nextIndex and retry (simple backoff strategy)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">442</span><span>                                    _nextIndex[otherId] = Math.Max(<span style=color:#bd93f9>1</span>, _nextIndex[otherId] - <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">443</span><span>                                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">444</span><span>                            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">445</span><span>                        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">446</span><span>                    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">447</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">448</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">449</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">450</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">451</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>void</span> UpdateCommitIndex()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">452</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">453</span><span>            <span style=color:#6272a4>// Leader updates commitIndex based on matchIndex</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">454</span><span>            <span style=color:#6272a4>// Find an N such that N &gt; current commitIndex, a majority of matchIndex &gt;= N, and _log[N].Term == currentTerm</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">455</span><span>            <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i = _log.Count; i &gt; _commitIndex; i--)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">456</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">457</span><span>                <span style=color:#8be9fd>var</span> count = _matchIndex.Values.Count(m =&gt; m &gt;= i) + <span style=color:#bd93f9>1</span>; <span style=color:#6272a4>// +1 includes self</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">458</span><span>                <span style=color:#ff79c6>if</span> (count &gt;= (_dispatcher.GetAllNodes().Count / <span style=color:#bd93f9>2</span> + <span style=color:#bd93f9>1</span>) &amp;&amp; _log[i - <span style=color:#bd93f9>1</span>].Term == _currentTerm)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">459</span><span>                {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">460</span><span>                    _commitIndex = i;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">461</span><span>                    ApplyStateMachine();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">462</span><span>                    <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">463</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">464</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">465</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">466</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">467</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#ff79c6>void</span> ApplyStateMachine()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">468</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">469</span><span>            <span style=color:#6272a4>// Apply logs from [lastApplied+1 ... commitIndex] to the state machine</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">470</span><span>            <span style=color:#ff79c6>while</span> (_lastApplied &lt; _commitIndex)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">471</span><span>            {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">472</span><span>                _lastApplied++;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">473</span><span>                <span style=color:#8be9fd>var</span> cmd = _log[_lastApplied - <span style=color:#bd93f9>1</span>].Command;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">474</span><span>                _stateMachine.Add(cmd);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">475</span><span>                Console.WriteLine(<span style=color:#f1fa8c>$&#34;[{_nodeId}] Apply LogIndex={_lastApplied}, Cmd={cmd}&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">476</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">477</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">478</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">479</span><span>        <span style=color:#ff79c6>#endregion</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">480</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">481</span><span>        <span style=color:#ff79c6>#region</span> Helper Methods
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">482</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">483</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> LastLogIndex()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">484</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">485</span><span>            <span style=color:#ff79c6>return</span> _log.Count;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">486</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">487</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">488</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> LastLogTerm()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">489</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">490</span><span>            <span style=color:#ff79c6>if</span> (_log.Count == <span style=color:#bd93f9>0</span>) <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">491</span><span>            <span style=color:#ff79c6>return</span> _log[_log.Count - <span style=color:#bd93f9>1</span>].Term;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">492</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">493</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">494</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> NodeRole Role =&gt; _role;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">495</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> CurrentTerm =&gt; _currentTerm;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">496</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> List&lt;<span style=color:#8be9fd>string</span>&gt; StateMachine =&gt; _stateMachine;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">497</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">498</span><span>        <span style=color:#ff79c6>#endregion</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">499</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">500</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">501</span><span>    <span style=color:#ff79c6>#endregion</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">502</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">503</span><span>    <span style=color:#ff79c6>#region</span> Simple <span style=color:#f1fa8c>&#34;RPC Dispatcher&#34;</span> to Simulate Network
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">504</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">505</span><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>InMemoryDispatcher</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">506</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">507</span><span>        <span style=color:#8be9fd;font-style:italic>private</span> Dictionary&lt;<span style=color:#8be9fd>string</span>, IRaftRpc&gt; _nodes = <span style=color:#ff79c6>new</span> Dictionary&lt;<span style=color:#8be9fd>string</span>, IRaftRpc&gt;();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">508</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">509</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>void</span> RegisterNode(<span style=color:#8be9fd>string</span> nodeId, IRaftRpc node)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">510</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">511</span><span>            _nodes[nodeId] = node;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">512</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">513</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">514</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> List&lt;<span style=color:#8be9fd>string</span>&gt; GetAllNodes() =&gt; _nodes.Keys.ToList();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">515</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">516</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> RequestVoteResponse SendRequestVote(<span style=color:#8be9fd>string</span> targetNodeId, RequestVoteRequest request)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">517</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">518</span><span>            <span style=color:#ff79c6>if</span> (!_nodes.ContainsKey(targetNodeId)) <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">519</span><span>            <span style=color:#ff79c6>return</span> _nodes[targetNodeId].RequestVote(request);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">520</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">521</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">522</span><span>        <span style=color:#8be9fd;font-style:italic>public</span> AppendEntriesResponse SendAppendEntries(<span style=color:#8be9fd>string</span> targetNodeId, AppendEntriesRequest request)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">523</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">524</span><span>            <span style=color:#ff79c6>if</span> (!_nodes.ContainsKey(targetNodeId)) <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">525</span><span>            <span style=color:#ff79c6>return</span> _nodes[targetNodeId].AppendEntries(request);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">526</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">527</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">528</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">529</span><span>    <span style=color:#ff79c6>#endregion</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">530</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">531</span><span>    <span style=color:#ff79c6>#region</span> Program Demo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">532</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">533</span><span>    <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Program</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">534</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">535</span><span>        <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>void</span> Main(<span style=color:#8be9fd>string</span>[] args)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">536</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">537</span><span>            <span style=color:#8be9fd>var</span> dispatcher = <span style=color:#ff79c6>new</span> InMemoryDispatcher();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">538</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">539</span><span>            <span style=color:#8be9fd>var</span> node1 = <span style=color:#ff79c6>new</span> RaftNode(<span style=color:#f1fa8c>&#34;Node1&#34;</span>, dispatcher);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">540</span><span>            <span style=color:#8be9fd>var</span> node2 = <span style=color:#ff79c6>new</span> RaftNode(<span style=color:#f1fa8c>&#34;Node2&#34;</span>, dispatcher);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">541</span><span>            <span style=color:#8be9fd>var</span> node3 = <span style=color:#ff79c6>new</span> RaftNode(<span style=color:#f1fa8c>&#34;Node3&#34;</span>, dispatcher);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">542</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">543</span><span>            node1.Start();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">544</span><span>            node2.Start();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">545</span><span>            node3.Start();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">546</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">547</span><span>            Console.WriteLine(<span style=color:#f1fa8c>&#34;Raft cluster started with 3 nodes (Node1, Node2, Node3).&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">548</span><span>            Console.WriteLine(<span style=color:#f1fa8c>&#34;Wait a few seconds to see leader election...&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">549</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">550</span><span>            <span style=color:#6272a4>// Wait a few seconds to allow election to complete</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">551</span><span>            Task.Delay(<span style=color:#bd93f9>5000</span>).Wait();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">552</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">553</span><span>            <span style=color:#6272a4>// Attempt to send a command to node1; if it&#39;s the Leader, it will execute, otherwise it will indicate it&#39;s not the Leader</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">554</span><span>            node1.SendClientCommand(<span style=color:#f1fa8c>&#34;SET X=100&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">555</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">556</span><span>            Task.Delay(<span style=color:#bd93f9>3000</span>).Wait();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">557</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">558</span><span>            <span style=color:#6272a4>// Stop node2 to simulate a crash</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">559</span><span>            Console.WriteLine(<span style=color:#f1fa8c>&#34;\n** Stopping Node2 to simulate crash **\n&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">560</span><span>            node2.Stop();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">561</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">562</span><span>            <span style=color:#6272a4>// Wait for a while before sending another command</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">563</span><span>            Task.Delay(<span style=color:#bd93f9>5000</span>).Wait();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">564</span><span>            node1.SendClientCommand(<span style=color:#f1fa8c>&#34;SET Y=200&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">565</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">566</span><span>            <span style=color:#6272a4>// Wait again to allow log replication to complete</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">567</span><span>            Task.Delay(<span style=color:#bd93f9>5000</span>).Wait();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">568</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">569</span><span>            <span style=color:#6272a4>// Print the data applied to the state machine of each node</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">570</span><span>            Console.WriteLine(<span style=color:#f1fa8c>$&#34;\nNode1 state: {string.Join(&#34;</span>, <span style=color:#f1fa8c>&#34;, node1.StateMachine)}&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">571</span><span>            Console.WriteLine(<span style=color:#f1fa8c>$&#34;\nNode2 state: {string.Join(&#34;</span>, <span style=color:#f1fa8c>&#34;, node2.StateMachine)} (Should not receive new logs after crash)&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">572</span><span>            Console.WriteLine(<span style=color:#f1fa8c>$&#34;\nNode3 state: {string.Join(&#34;</span>, <span style=color:#f1fa8c>&#34;, node3.StateMachine)}&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">573</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">574</span><span>            <span style=color:#6272a4>// Shutdown</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">575</span><span>            node1.Stop();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">576</span><span>            node2.Stop();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">577</span><span>            node3.Stop();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">578</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">579</span><span>            Console.WriteLine(<span style=color:#f1fa8c>&#34;\nDemo finished. Press any key to exit.&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">580</span><span>            Console.ReadKey();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">581</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">582</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">583</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">584</span><span>    <span style=color:#ff79c6>#endregion</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">585</span><span>}
</span></span></code></pre></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="David (Ziyuan) Zhang" src=/img/author_hu6891572442198357328.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">David (Ziyuan) Zhang</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/wacry target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://icpc.global/ICPCID/6RP5EXAXJZWB target=_blank aria-label=Acm rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg width="32" height="32" viewBox="0 0 32 32"><path fill="currentcolor" d="M9.912 16.333c-.105.031-.199.093-.267.183-.067.093-.099.208-.093.323.0.203.047.339.156.412.104.072.261.109.475.109.115.0.229-.027.348-.079.12-.052.235-.131.329-.219v-.88c-.224.015-.407.036-.543.057-.14.015-.276.047-.405.093zM16 0 0 16l16 16 16-16zm0 25.807c-5.416.0-9.807-4.391-9.807-9.807S10.584 6.193 16 6.188c5.416.005 9.807 4.396 9.807 9.812S21.416 25.807 16 25.807zM16 7.172c-4.869.0-8.828 3.953-8.828 8.828.0 4.869 3.959 8.823 8.828 8.823S24.828 20.87 24.828 16c0-4.875-3.953-8.828-8.828-8.833zM12.183 18.161H10.86v-.448l-.245.208c-.188.147-.407.251-.636.313-.109.025-.271.047-.468.047-.349.005-.688-.131-.932-.38-.251-.256-.371-.573-.371-.959.0-.317.063-.568.188-.765.135-.199.317-.36.541-.464.271-.12.563-.203.86-.24.333-.041.687-.077 1.072-.104v-.02c0-.235-.088-.396-.265-.485-.172-.093-.427-.135-.771-.135-.156.0-.339.025-.547.083s-.412.136-.609.219h-.115v-1.025c.125-.041.339-.084.635-.136.292-.052.589-.077.885-.077.735.0 1.267.12 1.6.364.333.245.5.62.5 1.12v2.891zm4.296-.218c-.093.036-.181.073-.271.115-.093.036-.197.079-.301.104-.125.032-.251.057-.365.084-.109.015-.26.025-.448.025-.348.0-.672-.041-.963-.131-.276-.083-.543-.223-.761-.411-.213-.188-.385-.427-.495-.693-.12-.281-.181-.609-.181-.984-.011-.359.056-.713.197-1.041.12-.271.297-.511.521-.704.219-.181.473-.312.744-.389.297-.089.599-.125.901-.125.495.0.979.115 1.416.339v1.14h-.171c-.063-.057-.125-.115-.199-.167-.077-.063-.161-.12-.249-.167-.219-.131-.475-.192-.729-.188-.339.0-.604.115-.787.349-.188.24-.281.552-.281.953.0.427.099.745.297.953.203.208.463.312.791.312.147.0.297-.015.439-.057.208-.057.395-.156.556-.296.063-.052.115-.109.163-.147h.171v1.12zM22.255 18.172v-2.131c0-.208.0-.385-.009-.525.0-.12-.027-.245-.068-.355-.032-.088-.095-.156-.172-.197-.208-.089-.437-.084-.641.0-.113.057-.224.119-.323.187v3.021h-1.328v-2.131c0-.208.0-.38-.011-.525-.005-.12-.025-.24-.067-.355-.037-.088-.1-.156-.183-.197-.079-.047-.193-.063-.333-.063-.109.0-.219.025-.317.072-.105.053-.204.115-.308.183v3.016h-1.323v-4.251h1.323v.475c.193-.167.396-.313.615-.432.197-.104.417-.161.645-.161.24-.005.48.061.683.187.203.136.36.328.453.552.255-.235.495-.416.724-.547.224-.125.453-.192.683-.192.181.0.359.031.531.099.151.063.292.156.401.281.12.14.208.307.265.484.057.193.089.437.089.74v2.765z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.linkedin.com/in/dz00/ target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:davidzhang20001112@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://buymeacoffee.com/davidzhangu target=_blank aria-label=Ko-Fi rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg width="211.67mm" height="211.67mm" viewBox="0 0 211.67 211.67"><defs><clipPath id="clipPath25"><path d="m0 6e2h1654.8V0H0z" fill="currentcolor"/></clipPath></defs><g transform="translate(-3.0786 -29.59)"><g transform="matrix(.35278 0 0 -.35278 3.0785 241.26)"><g clip-path="url(#clipPath25)"><g transform="translate(600 300)"><path d="m-3e2 3e2c-165.69.0-3e2-134.31-3e2-3e2s134.31-3e2 3e2-3e2C-134.32-3e2.0-165.69.0.0s-134.32 3e2-3e2 3e2zm-188.93-166.99h329.58c23.223.0 46.032-6.8325 65.073-20.125 18.412-12.856 36.378-33.646 42.697-67.02 14.674-77.514-43.568-135.76-126.12-131.18.438-21.268-3.8105-59.422-44.878-69.696-3.282-.821-6.6604-1.186-10.044-1.207-72.13-.448-222.53-.88916-222.53-.88916s-46.066-.01555-49.176 45.962c-1.023 77.88-.48339 223.69-.48339 223.69s-.02651 2.9267-.02051 3.6577c.043 5.607 4.4359 16.8 15.901 16.8zm312.71-55.573v-107.8s14.302-1.6507 31.907.54932c20.356 6.6 39.06 20.901 39.06 57.199.0 14.85-5.2614 25.601-11.837 33.239-9.341 10.848-23.152 16.809-37.469 16.809h-21.661z" fill="currentcolor"/></g><g transform="translate(256.61 203.37)"><path d="m0 0c3.585-1.806 5.876.437 5.876.437s52.457 47.878 76.089 75.452c21.018 24.667 22.389 66.234-13.708 81.766-36.096 15.532-65.795-18.272-65.795-18.272-25.755 28.326-64.734 26.891-82.763 7.721-18.027-19.169-11.732-52.072 1.717-70.383 12.626-17.19 68.119-66.65 76.529-75.015.0.0.614-.641 2.055-1.706" fill="currentcolor"/></g></g></g></g></svg></span></span></a></div></div></div></div><div class=mb-10></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://wacry.github.io/posts/1735548655536-raft-intro/&amp;title=Detailed%20explanation%20of%20Raft%20algorithm" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://wacry.github.io/posts/1735548655536-raft-intro/&amp;text=Detailed%20explanation%20of%20Raft%20algorithm" title="Tweet on Twitter" aria-label="Tweet on Twitter"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://s2f.kytta.dev/?text=Detailed%20explanation%20of%20Raft%20algorithm%20https://wacry.github.io/posts/1735548655536-raft-intro/" title aria-label><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://wacry.github.io/posts/1735548655536-raft-intro/&amp;resubmit=true&amp;title=Detailed%20explanation%20of%20Raft%20algorithm" title="Submit to Reddit" aria-label="Submit to Reddit"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://pinterest.com/pin/create/bookmarklet/?url=https://wacry.github.io/posts/1735548655536-raft-intro/&amp;description=Detailed%20explanation%20of%20Raft%20algorithm" title="Pin on Pinterest" aria-label="Pin on Pinterest"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M496 256c0 137-111 248-248 248-25.6.0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8.0 128.7-68.8 128.7-154.3.0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1.0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6.0-54.7 41.4-107.6 112-107.6 60.9.0 103.6 41.5 103.6 100.9.0 67.1-33.9 113.6-78 113.6-24.3.0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6.0-19-10.2-34.9-31.4-34.9-24.9.0-44.9 25.7-44.9 60.2.0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9.0 361.1.0 256 0 119 111 8 248 8s248 111 248 248z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://wacry.github.io/posts/1735548655536-raft-intro/&amp;quote=Detailed%20explanation%20of%20Raft%20algorithm" title="Share on Facebook" aria-label="Share on Facebook"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></span></a></section><h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><a href=/posts/1735350760948-cap/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/1735350760948-cap/featured_hu6958449520574469626.jpg)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/1735350760948-cap/>In-depth explanation of the CAP theorem: Building high-concurrency and high-availability distributed systems</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2024-12-28T00:00:00+00:00>28 December 2024</time><span class="px-2 text-primary-500">&#183;</span><span>2856 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">14 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_posts/1735350760948-cap/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_posts/1735350760948-cap/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/distributed-system/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Distributed System
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/cap-theorem/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">CAP Theorem
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/distributed-consensus-algorithm/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Distributed Consensus Algorithm
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/system-design/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">System Design</span></span></span></div></div><div class="py-1 prose dark:prose-invert">Discussing the Application of the CAP Theorem in Distributed Systems from Theory to Practice.</div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/1735252761946-quick-sort/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/1735252761946-quick-sort/featured_hu9517526573802239776.png)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/1735252761946-quick-sort/>Quick Sort</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2024-12-26T00:00:00+00:00>26 December 2024</time><span class="px-2 text-primary-500">&#183;</span><span>1045 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">5 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_posts/1735252761946-quick-sort/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_posts/1735252761946-quick-sort/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/algorithm/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Algorithm
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/sorting-algorithm/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Sorting Algorithm
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/quick-sort/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Quick Sort
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/divide-and-conquer-algorithm/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Divide and Conquer Algorithm</span></span></span></div></div><div class="py-1 prose dark:prose-invert">Key Points for Correctly Implementing the Quick Sort Algorithm.</div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/1735112650761-0-1-knapsack-problem/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/1735112650761-0-1-knapsack-problem/featured_hu5960540421944084276.png)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/1735112650761-0-1-knapsack-problem/>0-1 knapsack problem</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2024-12-24T00:00:00+00:00>24 December 2024</time><span class="px-2 text-primary-500">&#183;</span><span>1369 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">7 mins</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=views_posts/1735112650761-0-1-Knapsack-Problem/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=views>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
</span></span></span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=likes_posts/1735112650761-0-1-Knapsack-Problem/index.md class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title=likes>loading</span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M47.6 300.4 228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6.0 115.2.0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/algorithm/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Algorithm
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/dynamic-programming/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Dynamic Programming
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/knapsack-problem/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Knapsack Problem</span></span></span></div></div><div class="py-1 prose dark:prose-invert">The most basic classic knapsack problem.</div></div><div class="px-6 pt-4 pb-2"></div></div></a></section></div><script>var oid="views_posts/1735548655536-raft-intro/index.md",oid_likes="likes_posts/1735548655536-raft-intro/index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/1735350760948-cap/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">In-depth explanation of the CAP theorem: Building high-concurrency and high-availability distributed systems</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2024-12-28T00:00:00+00:00>28 December 2024</time>
</span></span></a></span><span></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><!doctype html><html lang=zh class=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Utterances with Tailwind Dark Mode</title></head><body><div id=utterances-container></div><script>function loadUtterances(e){const t=document.createElement("script");t.src="https://utteranc.es/client.js",t.async=!0,t.crossOrigin="anonymous",t.setAttribute("repo","WAcry/wacry.github.io"),t.setAttribute("issue-term","pathname"),t.setAttribute("label","Utterances"),t.setAttribute("theme",e),document.getElementById("utterances-container").appendChild(t)}function renderUtterances(){const e=document.documentElement.classList.contains("dark")?"github-dark":"github-light",t=document.getElementById("utterances-container");t.innerHTML="",loadUtterances(e)}document.addEventListener("DOMContentLoaded",()=>{renderUtterances()});const observer=new MutationObserver(e=>{for(const t of e)t.attributeName==="class"&&renderUtterances()});observer.observe(document.documentElement,{attributes:!0})</script></body></html></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">CC BY-NC-SA 4.0</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://wacry.github.io/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>